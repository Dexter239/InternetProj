<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <title>Main</title>
    <style>
       body {
        background: url({%static "img/background_v3.jpg"%});
        -moz-background-size: 100%; /* Firefox 3.6+ */
        -webkit-background-size: 100%; /* Safari 3.1+ и Chrome 4.0+ */
        -o-background-size: 100%; /* Opera 9.6+ */
        background-size: 100%; /* Современные браузеры */
       }
    </style>
</head>
<script>
    function search_user(search_input) {

        $.ajax({
            type: "GET",
            url: "/search_user/",
            dataType: "html",
            data: {'username': search_input.value},
            success: function (data) {
              users = document.getElementById("searchPreview");
              if (data)
              users.innerHTML = data;
              else
                 users.innerHTML = "<p>Ничего не найдено!</p>";
            }
        })
    }
    function allow_send() {
        $.ajax({
            type: "POST",
            url: "/change_rights/",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            dataType: "html",
            data: {'userID': {{  user.id }} , 'rights': 'allow'},
            success: function (data) {
             location.reload()
            }
        })
    }

    function decline_send() {
        $.ajax({
            type: "POST",
            url: "/change_rights/",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            dataType: "html",
            data: {'userID': {{  user.id }} , 'rights': 'decline'},
            success: function (data) {
             location.reload()
            }
        })
    }
    var contentLength = 22;
    function removeNotify() {
         $.ajax({
            type: "POST",
            url: "/notifications/",
             headers: { "X-CSRFToken": "{{ csrf_token }}" },
            dataType: "html",
            data: {'userID': {{ myself.id }},'action': 'remove'},
            success: function (data) {
                contentLength=data.length;
                $('.modal-body').html(data);
            }
        })
    }
     function update(){
        $.ajax({
            type: "POST",
            url: "/notifications/",
             headers: { "X-CSRFToken": "{{ csrf_token }}" },
            dataType: "html",
            data: {'userID': {{ myself.id }},'action': 'update'},
            success: function (data) {
                if (data.length>contentLength) {
                    bell = $('.fa-bell-o');
                    bell.removeClass('fa-bell-o');
                    bell.addClass('fa-bell');

                }
                contentLength=data.length
                $('.modal-body').html(data);
            }
        })
    }
    $( document ).ready(function() {
    let timerID = setInterval(update,7000)
});
</script>
<body>
    <div class="conteiner">
        <div class="header">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a href="/main/" class="navbar-brand"><img src="{%static "img/logo_mini2.png"%}" alt="logo" class="d-inline-block align-top"></a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                  <form class="form-inline my-2 my-lg-0" id="search" >
                      <div class="dropdown">
                            <input class="form-control mr-sm-2" id="search-keywords" type="search" style="font-family: FontAwesome, sans-serif;" placeholder="&#61442; Поиск пользователей" aria-label="Search" onfocus="$('button.dropdown-toggle').click();" onkeyup="search_user(this)">
                            <button hidden class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown"></button>
                            <ul id="searchPreview" class="dropdown-menu"></ul>
                      </div>
                  </form>
                  <div id="notifications" style="margin-right: 10px"><i onmouseover="" style="cursor: pointer;"  data-toggle="modal" data-target="#shownotifications" class="fa fa-bell-o fa-2" onclick="$(this).removeClass('fa-bell'); $(this).addClass('fa-bell-o');" aria-hidden="true"></i></div>
                    <ul class="navbar-nav ml-auto">
                    <li class="nav-item active">
                      <a class="nav-link">{{myself.username}} <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item active">
                      <a class="nav-link" href="/logout/">Выход <span class="sr-only">(current)</span></a>
                    </li>
                  </ul>

                </div>
            </nav>
        </div>
        <div class="main">
            <div>
            <p class="text-center" style="padding-top: 10%; font-family: inherit; font-size: 40px;">Профиль {{ user.username }}</p>
            </div>
        <div class="text-center">
         {% if user.profile in myself.profile.friends.all %}
                <button class="btn btn-secondary" onclick="decline_send()">Удалить пользователя из друзей</button>
                {% else %}
                <button class="btn  btn-secondary" onclick="allow_send()">Добавить пользователя в друзья</button>
            {% endif %}
            <div class="d-flex justify-content-center" style="margin-top: 10%; padding-bottom: 10%;">
                {% if myself.profile in user.profile.friends.all %}
            <form class="custom-file" style="width: 70%" id="file" action="/download_file/{{ user.id }}/" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                <div  id="customFile" lang="es">
                    <input name="file" type="file" class="custom-file-input" id="fileinput"
                      aria-describedby="filehelp" onchange="send_form.click()">
                    <label class="custom-file-label" style="text-align: left" for="fileinput">Выберите файл</label>
                    <input type="submit" id="send_form" name="send_form" hidden>
                </div>
                </form>

                 {% else %}
                <p>Пользователь не разрешал вам отправлять файлы</p>
                {% endif %}
</div>
            </div>
        </div>
        <div class="footer"></div>
    </div>
 <div class="modal fade" id="shownotifications"  tabindex="-1" role="dialog" aria-labelledby="notificationsLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notificationsLabel">Ваши уведомления</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        {% for note in notify %}
            {{  note.notify | safe }}
         {% endfor %}

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="removeNotify()">Очистить список уведомлений</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>